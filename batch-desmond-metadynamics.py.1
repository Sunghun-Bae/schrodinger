import sys
import os
import re
import shutil
import random
import argparse

multisim = "{}/utilities/multisim".format(os.environ["SCHRODINGER"])

# desmond MD NPT relaxation protocol
desmond_metad_msj = """# Desmond standard NPT relaxation protocol
# All times are in the unit of ps.
# Energy is in the unit of kcal/mol.
task {
   task = "desmond:auto"
   set_family = {
      desmond = {
         checkpt.write_last_step = no
      }
   }
}

simulate {
   title       = "Brownian Dynamics NVT, T = 10 K, small timesteps, and restraints on solute heavy atoms, 100ps"
   annealing   = off
   time        = 100
   timestep    = [0.001 0.001 0.003 ]
   temperature = 10.0
   ensemble = {
      class = "NVT"
      method = "Brownie"
      brownie = {
         delta_max = 0.1
      }
   }
   restrain = {
      atom = "solute_heavy_atom"
      force_constant = 50.0
   }
}

simulate {
   title       = "NVT, T = 10 K, small timesteps, and restraints on solute heavy atoms, 12ps"
   annealing   = off
   time        = 12
   timestep    = [0.001 0.001 0.003]
   temperature = 10.0
   restrain    = { atom = solute_heavy_atom force_constant = 50.0 }
   ensemble    = {
      class  = NVT
      method = Berendsen
      thermostat.tau = 0.1
   }

   randomize_velocity.interval = 1.0
   eneseq.interval             = 0.3
   trajectory.center           = []
}

simulate {
   title       = "NPT, T = 10 K, and restraints on solute heavy atoms, 12ps"
   annealing   = off
   time        = 12
   temperature = 10.0
   restrain    = retain
   ensemble    = {
      class  = NPT
      method = Langevin
      thermostat.tau = 0.1
      barostat  .tau = 50.0
   }

   randomize_velocity.interval = 1.0
   eneseq.interval             = 0.3
   trajectory.center           = []
}

solvate_pocket {
   should_skip = true
   ligand_file = ?
}

simulate {
   title       = "NPT and restraints on solute heavy atoms, 12ps"
   effect_if   = [["@*.*.annealing"] 'annealing = off temperature = "@*.*.temperature[0][0]"']
   time        = 12
   restrain    = retain
   ensemble    = {
      class  = NPT
      method = Langevin
      thermostat.tau = 0.1
      barostat  .tau = 50.0
   }

   randomize_velocity.interval = 1.0
   eneseq.interval             = 0.3
   trajectory.center           = []
}

simulate {
   title       = "NPT and no restraints, 24ps"
   effect_if   = [["@*.*.annealing"] 'annealing = off temperature = "@*.*.temperature[0][0]"']
   time        = 24
   ensemble    = {
      class  = NPT
      method = Langevin
      thermostat.tau = 0.1
      barostat  .tau = 2.0
   }

   eneseq.interval   = 0.3
   trajectory.center = solute
}

simulate {
   cfg_file = "desmond_metadynamics_job_1.cfg"
   jobname  = "$MASTERJOBNAME"
   dir      = "."
   compress = ""
   meta = {
      cv = [
         {atom = ["res. UNK" "res. 849" ]
          type = dist
          wall = 40
          width = 0.05
         }
      ]
      cv_name = "$JOBNAME$[_replica$REPLICA$].cvseq"
      first = 0.0
      height = 0.03
      interval = 0.09
      name = "$JOBNAME$[_replica$REPLICA$].kerseq"
   }
   backend ={
      # set cvseq interval to trajectory output
      force.term.ES.interval = '@*.*.*.*.trajectory.interval'
   }
   checkpt.write_last_step = yes
}
"""


# desmond MD production protocol
desmond_metad_cfg = """annealing = false
backend = {
}
bigger_rclone = false
checkpt = {
   first = 0.0
   interval = 200.0
   name = "$JOBNAME.cpt"
   write_last_step = true
}
cpu = 1
cutoff_radius = 9.0
elapsed_time = 0.0
energy_group = false
eneseq = {
   first = 0.0
   interval = 1.2
   name = "$JOBNAME$[_replica$REPLICA$].ene"
}
ensemble = {
   barostat = {
      tau = 2.0
   }
   class = NPT
   method = MTK
   thermostat = {
      tau = 1.0
   }
}
glue = solute
maeff_output = {
   first = 0.0
   interval = 120.0
   name = "$JOBNAME$[_replica$REPLICA$]-out.cms"
   periodicfix = true
   trjdir = "$JOBNAME$[_replica$REPLICA$]_trj"
}
meta_file = ?
pressure = [1.01325 isotropic ]
randomize_velocity = {
   first = 0.0
   interval = inf
   seed = 2967
   temperature = "@*.temperature"
}
restrain = none
simbox = {
   first = 0.0
   interval = 1.2
   name = "$JOBNAME$[_replica$REPLICA$]_simbox.dat"
}
surface_tension = 0.0
taper = false
temperature = [
   [300.0 0 ]
]
time = 600.0
timestep = [0.002 0.002 0.006 ]
trajectory = {
   center = []
   first = 0.0
   format = dtr
   frames_per_file = 250
   @interval = 50.0
   name = "$JOBNAME$[_replica$REPLICA$]_trj"
   periodicfix = true
   write_velocity = false
}
"""

seed_ = re.compile(r'seed = [0-9]+')
time_ = re.compile(r'[^_]time = [.0-9]+')
interval_ = re.compile(r'[^_]@interval = [.0-9]+')
cfg_  = re.compile(r'cfg_file = ["_.0-9a-zA-Z]+')

parser = argparse.ArgumentParser(description="batch gdesmond metadynamics jobs",
    formatter_class=argparse.ArgumentDefaultsHelpFormatter)
parser.add_argument('-g','--gpu', dest="gpu_device", type=int, default=0, help="gpu device id")
parser.add_argument('-t','--time', dest="simulation_time", type=float, default=100.0, help="simulation time in ns")
parser.add_argument('-i','--interval', dest="interval", type=float, help="frame interval in ps")
parser.add_argument('-p','--prefix', dest="prefix", default="metad", help="directory prefix")
parser.add_argument('-s','--start', dest="start", type=int, default=1, help="directory start")
parser.add_argument('-r','--repeat', dest="repeat", type=int, default=1, help="number of repeats")
parser.add_argument('-j','--jobfile', dest="job_file", default="desmond_metadynamics_job_1.sh", help="job filename")
parser.add_argument('cms', nargs="+", help="desmond cms file")
args = parser.parse_args()

try:
    cms_files = [os.path.abspath(f) for f in args.cms]
    assert(len(cms_files) > 0)
except:
    print(".cms file(s) not found")
    sys.exit(0)

opt  = '-HOST localhost -maxjob 1 -cpu 1 -mode umbrella -lic "DESMOND_GPGPU:16"'

if not args.interval:
    args.interval = args.simulation_time # it will save 1000 frames

job_file = args.job_file
while os.path.exists(job_file):
    splited = job_file.replace(".sh","").split("_")
    splited[-1] = str(int(splited[-1]) + 1)
    job_file = "_".join(splited) + ".sh"


with open("README","a") as readme, open(job_file,"w") as job:
    print(f"Job file = {job_file}")

    readme.write("="*40+"\n")
    readme.write(f"GPU device= {args.gpu_device}\n")
    readme.write(f"Time(ns)= {args.simulation_time}\n")
    readme.write(f"Trajectory interval(ps)= {args.interval}\n")
    readme.write(f"Repeat= {args.repeat}\n")
    readme.write(f"Jobfile= {job_file}\n\n")
    
    job.write(f'export CUDA_VISIBLE_DEVICES="{args.gpu_device}"\n\n')

    for i, infile in enumerate(cms_files):
        info = f"[{i+1}] {infile}"
        print(info)
        readme.write(info+"\n")
    dirs = [ f"{args.prefix}{n:02d}" for n in range(args.start, args.start+args.repeat) ]
    readme.write("directory = %s\n" % " ".join(dirs))
    readme.write("="*40+"\n\n")

    for n in range(args.start, args.start+args.repeat): 
        outdir = f"{args.prefix}{n:02d}"
        outdir_abspath = os.path.abspath(outdir)
        job.write(f"cd {outdir_abspath}/\n\n")
        if not os.path.exists(outdir):
            os.makedirs(outdir)
        cfg_file = f"{outdir}/desmond_metadynamics_job_{n:02d}.cfg"
        msj_file = f"{outdir}/desmond_metadynamics_job_{n:02d}.msj"
        cfg_file_basename= os.path.basename(cfg_file)

        with open(cfg_file,"w") as cfg:
            # modify templates
            desmond_metad_cfg = seed_.sub(f"seed = {random.randint(1000,9999)}", desmond_metad_cfg)
            desmond_metad_cfg = time_.sub(f"\ntime = {args.simulation_time*1000.}", desmond_metad_cfg)
            desmond_metad_cfg = interval_.sub(f" interval = {args.interval}", desmond_metad_cfg)
            cfg.write(desmond_metad_cfg)

        with open(msj_file,"w") as msj:
            # modify templates
            desmond_metad_msj = cfg_.sub(f'cfg_file = "{cfg_file_basename}"', desmond_metad_msj)
            msj.write(desmond_metad_msj)
        
        for infile in cms_files:
            prefix_ = re.sub(r'desmond_setup[-_]','', os.path.basename(infile))
            prefix  = prefix_.replace("-out.cms","")
            
            job_name = f"desmond_metadynamics_job_{n:02d}_{prefix}"
            job.write('{} -JOBNAME {} -m {} -c {} -description "{}" {} {} -o {} -WAIT\n\n'.format(
                multisim, 
                job_name, 
                os.path.basename(msj_file),
                os.path.basename(cfg_file),
                "GPU desmond metadynamics",
                opt,
                os.path.join("..",infile),
                f"{job_name}-out.cms",
            ))

os.chmod(job_file, 0o777)
